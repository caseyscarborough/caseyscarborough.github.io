<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Database Migrations in Grails &middot; caseyscarborough.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.ico" type="image/png">

    <link href="/assets/stylesheets/app-d69b7bfe.css" rel="stylesheet" type="text/css" />
    <script src="/assets/javascripts/app-693e4d68.js" type="text/javascript"></script>
</head>
    <body>

    <div id="wrap">
      <header class="navbar navbar-inverse navbar-fixed-top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".cs-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">CASEY SCARBOROUGH</a>
    </div>
    <nav class="collapse navbar-collapse cs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        <li><a href="/">Home</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="/projects/">Projects</a></li>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/activity/">Activity</a></li>
      </ul>
    </nav>
  </div>
</header>

      <div class="content">
        <br>
        <div class="container">
          <div class="row">
            <div class="col-md-2 hidden-sm"></div>
            <div class="col-md-8">
              <h2>Database Migrations in Grails</h2>
              <p class="meta">02 Apr 2014 &middot; By <a href="mailto:caseyscarborough@gmail.com">Casey Scarborough</a></p>

              <div class="post">
                <p>When developing a web application, it is often important to make structural changes to the database backing it, as well as keep track of these changes and make it easy for other developers to make the same ones. For this, <em>database migrations</em> are the tool to use. They give you this support and functionality, as well as many other things such as rolling back database changes and generating data for newly created non-nullable columns. If you are familiar with the <a href="http://rubyonrails.org/">Rails</a> web framework, then you&#39;ve probably used these before, but these don&#39;t come natively using <a href="http://grails.org">Grails</a>. This post aims to give a quick overview of getting up and running with them, as well as writing your own custom migrations for specific use cases.</p>

<h2>Getting Started</h2>

<p>The first step is to add the dependency for the <a href="http://grails.org/plugin/database-migration">Grails Database Migration Plugin</a> to your <code>BuildConfig.groovy</code> file.</p>

<pre><code class="groovy">plugins {
  runtime &quot;:database-migration:1.3.8&quot;
}
</code></pre>

<p>Then, in your <code>DataSource.groovy</code> file, you&#39;ll want to disable Grails&#39; automatic update of your database for all environments:</p>

<pre><code class="java">environments {
  development {
    dataSource {
      // Change this:
      dbCreate = &quot;create-drop&quot;
      // To this:
      dbCreate = &quot;none&quot;
    }
  }
  // Repeat for test and production
  // ...
}
</code></pre>

<p>Afterwards, you&#39;ll want to generate the initial changelog which is essentially a dump of your database in its current state, in migration form. Migrations with Grails can be either <a href="http://groovy.codehaus.org/">Groovy</a> or <a href="http://en.wikipedia.org/wiki/XML">XML</a> format, but using the Groovy format has its advantages (XML files are unable to include Groovy files). To generate the initial changelog, issue the following command:</p>

<pre><code class="bash"># Generate using Groovy
grails dbm-generate-changelog changelog.groovy

# Generate using XML
grails dbm-generate-changelog changelog.xml
</code></pre>

<p>This will create the <code>changelog.groovy</code> (or <code>changelog.xml</code>) file in the <code>grails-app/migrations</code> folder. </p>

<p>This is great if you&#39;ve already created your database, but what if you haven&#39;t? If you&#39;re starting from scratch and Grails hasn&#39;t autogenerated the database for you, you can issue the following command to generate the initial changelog from your domain classes.</p>

<pre><code class="bash">grails dbm-generate-gorm-changelog changelog.groovy
</code></pre>

<p>Now we are ready to start performing migrations.</p>

<p>After creating a migration, you&#39;ll always want to update the database, and then mark all changes as executed in the database. You can do that with the following commands:</p>

<pre><code class="bash"># Update the database
grails dbm-update

# Mark changes as executed
grails dbm-changelog-sync
</code></pre>

<h2>Generating and Using Migrations</h2>

<p><strong>Every time</strong> you make a change to your schema, such as adding a field to a domain class, creating a new domain class, etc., you&#39;ll need to create and run a migration. After making a schema change, you&#39;ll want to issue the following command to generate a new migration to be run:</p>

<pre><code class="bash"># Replace name-of-migration with your name, such as create-user-class.groovy
grails dbm-gorm-diff name-of-migration.groovy -add
</code></pre>

<p>This particular command would create the <code>name-of-migration.groovy</code> file in the <code>grails-app/migrations</code> folder. To add this file to the list of migrations, we append the <code>-add</code> option. This will add the <code>include file: &#39;name-of-migration.groovy&#39;</code> line in your initial changelog file. This is so that whenever a new developer or you try to run the migrations from scratch, they&#39;ll all execute sequentially in the order that they were created. You can open up your newly created migration and check it out. Here&#39;s an example of one that I created for a <code>Room</code> domain class:</p>

<pre><code class="groovy">class Room {
    String name
    Integer roomNumber
    String description  

    static constraints = {
        description(nullable: true)
    }
}
</code></pre>

<pre><code class="groovy">// Database migration for the creation of the Room class
databaseChangeLog = {

    changeSet(author: &quot;cscarborough (generated)&quot;, id: &quot;1393858050907-1&quot;) {
        createTable(tableName: &quot;rooms&quot;) {
            column(name: &quot;id&quot;, type: &quot;number(19,0)&quot;) {
                constraints(nullable: &quot;false&quot;, primaryKey: &quot;true&quot;, primaryKeyName: &quot;roomsPK&quot;)
            }

            column(name: &quot;version&quot;, type: &quot;number(19,0)&quot;) {
                constraints(nullable: &quot;false&quot;)
            }

            column(name: &quot;name&quot;, type: &quot;varchar2(255 char)&quot;) {
                constraints(nullable: &quot;false&quot;)
            }

            column(name: &quot;room_number&quot;, type: &quot;number(10,0)&quot;) {
                constraints(nullable: &quot;false&quot;)
            }

            column(name: &quot;description&quot;, type: &quot;varchar2(255 char)&quot;)
        }
    }
}
</code></pre>

<p>Now we can go ahead and run it:</p>

<pre><code class="bash">grails dbm-update
grails dbm-changelog-sync
</code></pre>

<p>This is the basic usage for the migrations plugin. Things aren&#39;t always this simple though. Let&#39;s take a look at creating a custom migration.</p>

<h2>Creating a Custom Migration</h2>

<p>There are many different reasons you may need to write a custom migration. One of the reasons I use this for time and time again, is when a non-nullable column is added to a table that already has data in it. After adding the field to your domain class, if you generate the migration, you&#39;ll see something like this:</p>

<pre><code class="groovy">databaseChangeLog = {
    changeSet(author: &quot;cscarborough (generated)&quot;, id: &quot;1393249516089-1&quot;) {
        addColumn(tableName: &quot;rooms&quot;) {
            column(name: &quot;max_capacity&quot;, type: &quot;number(10,0)&quot;) {
                constraints(nullable: &quot;false&quot;)
            }
        }
    }
}
</code></pre>

<p>If you run this migration, you will receive a very large stacktrace, complaining about adding a NOT NULL column to a table with data in it. We can resolve this by creating a custom migration. The idea is that we want to create the column as nullable, set some default data, then add our not null constraint. Here&#39;s how that looks:</p>

<pre><code class="groovy">databaseChangeLog = {
    changeSet(author: &quot;Casey Scarborough&quot;, id: &quot;201404020858-add-max-capacity-to-rooms&quot;) {
        addColumn(tableName: &quot;rooms&quot;) {
            column(name: &quot;max_capacity&quot;, type: &quot;number(10,0)&quot;)
        }

        grailsChange {
            change {
                sql.execute(&quot;UPDATE rooms SET max_capacity = 100&quot;)
                confirm &quot;Successfully set default value for max_capacity.&quot;
            }
        }

        addNotNullConstraint(tableName: &quot;rooms&quot;, columnName: &quot;max_capacity&quot;)
    }
}
</code></pre>

<p>Whenever writing your own migrations, your <code>id</code> can be whatever you like, but I prefer a timestamp and a short description of the migration. You can also add a call to <code>confirm</code>, which will display a message when the change successfully completes.</p>

<p>Now, if you re-run the migration it will succeed.</p>

<h2>Custom Migration Examples</h2>

<p>The following are some examples of common custom migrations:</p>

<h3>Dropping a Table or Column</h3>

<pre><code class="groovy">databaseChangeLog = {    
    changeSet(author: &quot;Casey Scarborough&quot;, id: &quot;201404020905-drop-column&quot;) {
        dropColumn(tableName: &quot;rooms&quot;, columnName: &quot;max_capacity&quot;)
        dropTable(tableName: &quot;crappy_table&quot;)
        confirm &quot;Successfully dropped column and table.&quot;
    }
}
</code></pre>

<h3>Renaming a Table or Column</h3>

<pre><code class="groovy">databaseChangeLog = {    
    changeSet(author: &quot;Casey Scarborough&quot;, id: &quot;201404020907-rename-column&quot;) {
        renameTable(oldTableName: &quot;rooms&quot;, newTableName: &quot;room&quot;)
        renameColumn(tableName: &quot;room&quot;, oldColumnName: &quot;room_number&quot;, newColumnName: &quot;room_no&quot;)
        confirm &quot;Successfully renamed table and column.&quot;
    }
}
</code></pre>

<h3>Changing a Column&#39;s Data Type</h3>

<pre><code class="groovy">databaseChangeLog = {    
    changeSet(author: &quot;Casey Scarborough&quot;, id: &quot;201404020909-modify-data-type&quot;) {
        modifyDataType(tableName: &quot;rooms&quot;, columnName: &quot;description&quot;, newDataType: &quot;varchar2(1000 char)&quot;)
        confirm &quot;Successfully updated the description column.&quot;
    }
}
</code></pre>

<h3>Deleting Records</h3>

<pre><code class="groovy">databaseChangeLog = {    
    changeSet(author: &quot;Casey Scarborough&quot;, id: &quot;201404021049-delete-records&quot;) {
        delete(tableName: &quot;rooms&quot;, whereClause: &quot;room_number &lt; 100&quot;)
        confirm &quot;Successfully removed all rooms with room number less than 100.&quot;
    }
}
</code></pre>

<h2>Resources</h2>

<ul>
<li><a href="http://grails-plugins.github.io/grails-database-migration/docs/manual/guide/introduction.html">Grails Database Migration Plugin Documentation</a></li>
</ul>

              </div>
              <br>
                <div class="comments">
                  <div id="disqus_thread"></div>
                  <script type="text/javascript">
                    var disqus_shortname = 'caseyscarboroughcom'; 
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                  </script>
                  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
  <div class="row">
    <div class="col-md-3 hidden-sm"></div>
    <div class="col-md-6">
      <div class="footer">
        <p class="pull-left icons">
          <a target="_blank" class="tooltip-link" title="Email" href="mailto:caseyscarborough@gmail.com"><i class="fa fa-envelope"></i></a>&nbsp;&nbsp;
          <a target="_blank" class="tooltip-link" title="GitHub" href="https://github.com/caseyscarborough/"><i class="fa fa-github"></i></a>&nbsp;&nbsp;
          <a target="_blank" class="tooltip-link" title="BitBucket" href="https://bitbucket.org/caseyscarborough/"><i class="fa fa-bitbucket"></i></a>&nbsp;&nbsp;
          <a target="_blank" class="tooltip-link" title="LinkedIn" href="https://linkedin.com/in/caseyscarborough"><i class="fa fa-linkedin"></i></a>&nbsp;&nbsp;
          <a target="_blank" class="tooltip-link" title="Google+" href="https://plus.google.com/103526747321763836028?rel=author"><i class="fa fa-google-plus"></i></a>
        </p>
        <p class="pull-right">
          <small class="meta">Contribute to this site on <a target="_blank" href="https://github.com/caseyscarborough/caseyscarborough.github.io">GitHub</a>.</small><br>
        </p>
      </div>
    </div>
  </div>
</div>
    </body>
</html>
