<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Using WebSockets in Grails &middot; caseyscarborough.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.ico" type="image/png">

    <link href="/assets/stylesheets/app-7716a11c.css" rel="stylesheet" type="text/css" />
    <script src="/assets/javascripts/app-fe2cd146.js" type="text/javascript"></script>
</head>
    <body>

    <div id="wrap">
      <header class="navbar navbar-inverse navbar-fixed-top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".cs-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">CASEY SCARBOROUGH</a>
    </div>
    <nav class="collapse navbar-collapse cs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        <li><a href="/">Home</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="https://github.com/caseyscarborough" target="_blank">GitHub</a></li>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/activity/">Activity</a></li>
      </ul>
    </nav>
  </div>
</header>

      <div class="content">
        <br>
        <div class="container">
          <div class="row">
            <div class="col-md-2 hidden-sm"></div>
            <div class="col-md-8">
              <h2>Using WebSockets in Grails</h2>
              <p class="meta">07 Dec 2014 &middot; By <a href="mailto:caseyscarborough@gmail.com">Casey Scarborough</a></p>

              <div class="post">
                <p><a href="https://developer.mozilla.org/en-US/docs/WebSockets">WebSockets</a> are a fairly new web technology that allows an open connection between a client (typically a web browser) and a server. They allow for message sending and receiving, as well as real-time updates. Unfortunately, like with many subjects in Grails, there isn&#39;t a lot of information on the web for getting started with them. This post aims to get you up and running with WebSockets in your Grails application. The version targeted in this post is the latest version at the time of this writing, Grails 2.4.4 using Java 8 (Java 7 should also work).</p>

<h2>Installing Necessary Dependencies</h2>

<p>You&#39;ll want to begin by adding the necessary dependency to your <code>grails-app/conf/BuildConfig.groovy</code> file. Add the following dependency to your <code>dependencies</code> block:</p>

<pre><code class="java">dependencies {
  bundle(&#39;javax.websocket:javax.websocket-api:1.1&#39;) {
    // This line is necessary for deployment to Tomcat, since
    // Tomcat comes with its own version of javax.websocket-api.
    export = false
  }  
}
</code></pre>

<h2>Creating Your WebSocket</h2>

<p>You&#39;ll want to create your WebSocket in your <code>src/groovy/{package-name}</code> directory. For this example, we&#39;ll create a WebSocket that handles the receiving and sending of messages to/from a chatroom.</p>

<p>Here is our WebSocket class:</p>

<pre><code class="java">package chatroom

import grails.util.Environment
import org.apache.log4j.Logger
import org.codehaus.groovy.grails.commons.GrailsApplication
import org.codehaus.groovy.grails.web.servlet.GrailsApplicationAttributes
import org.springframework.context.ApplicationContext

import javax.servlet.ServletContext
import javax.servlet.ServletContextEvent
import javax.servlet.ServletContextListener
import javax.servlet.annotation.WebListener
import javax.websocket.*
import javax.websocket.server.ServerContainer
import javax.websocket.server.ServerEndpoint

@ServerEndpoint(&quot;/chatroom&quot;)
@WebListener
class ChatroomEndpoint implements ServletContextListener {

  private static final Logger log = Logger.getLogger(ChatroomEndpoint.class)
  private static final Set&lt;Session&gt; users = ([] as Set).asSynchronized()

  @Override
  void contextInitialized(ServletContextEvent servletContextEvent) {
    ServletContext servletContext = servletContextEvent.servletContext
    ServerContainer serverContainer = servletContext.getAttribute(&quot;javax.websocket.server.ServerContainer&quot;)

    try {
      // This is necessary for Grails to add the endpoint in development.
      // In production, the endpoint will be added by the @ServerEndpoint
      // annotation.
      if (Environment.current == Environment.DEVELOPMENT) {
        serverContainer.addEndpoint(ChatroomEndpoint)
      }

      // This is mainly for demonstration of retrieving the ApplicationContext,
      // the GrailsApplication instance, and application configuration.
      ApplicationContext ctx = (ApplicationContext) servletContext.getAttribute(GrailsApplicationAttributes.APPLICATION_CONTEXT)
      GrailsApplication grailsApplication = ctx.grailsApplication
      serverContainer.defaultMaxSessionIdleTimeout = grailsApplication.config.servlet.defaultMaxSessionIdleTimeout ?: 0
    } catch (IOException e) {
      log.error(e.message, e)
    }
  }

  @Override
  void contextDestroyed(ServletContextEvent servletContextEvent) {
  }

  /**
   * This method is executed when a client connects to this websocket
   * endpoint, and adds the new user&#39;s session to our users list.
   */
  @OnOpen
  public void onOpen(Session userSession) {
    users.add(userSession)
  }

  /**
   * This method is executed when a client sends a message to the
   * websocket endpoint. It sets the first message that the user sends
   * as the user&#39;s username, and treats all others as a message to
   * the chatroom.
   * @param message
   * @param userSession
   */
  @OnMessage
  public void onMessage(String message, Session userSession) {
    String username = userSession.userProperties.get(&quot;username&quot;)

    if (!username) {
      userSession.userProperties.put(&quot;username&quot;, message)
      sendMessage(String.format(&quot;%s has joined the chatroom.&quot;, message))
      return
    }

    // Send the message to all users in the chatroom.
    sendMessage(message, userSession)
  }

  /**
   * This method is executed when a user disconnects from the chatroom.
   */
  @OnClose
  public void onClose(Session userSession, CloseReason closeReason) {
    String username = userSession.userProperties.get(&quot;username&quot;)
    users.remove(userSession)
    userSession.close()

    if (username) {
      sendMessage(String.format(&quot;%s has left the chatroom.&quot;, username))
    }
  }

  @OnError
  public void onError(Throwable t) {
    log.error(t.message, t)
  }

  /**
   * Iterate through all chatroom users and send a message to them.
   * @param message
   */
  private void sendMessage(String message, Session userSession=null) {
    if (userSession) {
      message = String.format(
        &quot;%s: %s&quot;, userSession.userProperties.get(&quot;username&quot;), message)
    }
    Iterator&lt;Session&gt;; iterator = users.iterator()
    while(iterator.hasNext()) {
      iterator.next().basicRemote.sendText(message)
    }
  }
}
</code></pre>

<h2>Registering the WebSocket Listener</h2>

<p>Next, you&#39;ll need to register your newly created WebSocket class in Grails&#39; <code>web.xml</code> file. By default, this file is not created in your Grails application directory, but you can create it by running the following command:</p>

<pre><code class="bash">grails install-templates
</code></pre>

<p>This will install the <code>web.xml</code> file in the <code>src/templates/war</code> directory. You can feel free to delete the other templates if you don&#39;t have a use for them. You&#39;ll want to add the following listener to that file:</p>

<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app version=&quot;3.0&quot;
         metadata-complete=&quot;true&quot;
         xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;&gt;

    &lt;!-- Add the following lines: --&gt;
    &lt;listener&gt;
        &lt;listener-class&gt;chatroom.ChatroomEndpoint&lt;/listener-class&gt;
    &lt;/listener&gt;
&lt;/web-app&gt;
</code></pre>

<p>Now your WebSocket should be ready to go when your application starts up. Now we just need to connect to it via JavaScript.</p>

<h2>Connecting to Your Endpoint Using JavaScript</h2>

<p>First, we&#39;ll want to create an example page to test out the chatroom. In your <code>grails-app/views/index.gsp</code> (or wherever you&#39;d like to connect to your endpoint), replace the contents with the following:</p>

<pre><code class="gsp">&lt;html&gt;
&lt;head&gt;
  &lt;meta name=&quot;layout&quot; content=&quot;main&quot;&gt;
  &lt;title&gt;WebSocket Example&lt;/title&gt;
  &lt;style&gt;
  #chatroom {
    padding: 10px;
  }

  #message {
    width: 400px;
    padding: 10px;
  }

  #log {
    width: 400px;
    height: 400px;
    border: 1px solid #ddd;
    overflow: auto;
    padding: 10px;
  }
  &lt;/style&gt;
  &lt;script&gt;
    $(document).ready(function () {
      var log = $(&quot;#log&quot;),
          message = $(&quot;#message&quot;),
          sendMessageButton = $(&quot;#send-message-button&quot;),

      // Create the WebSocket URL link. This URI maps to the URI you specified
      // in the @ServerEndpoint annotation in ChatroomEndpoint.groovy.
          webSocketUrl = &quot;${createLink(uri: &#39;/chatroom&#39;, absolute: true).replaceFirst(/http/, /ws/)}&quot;,

      // Connect to the WebSocket.
          socket = new WebSocket(webSocketUrl);

      socket.onopen = function () {
        log.append(&quot;&lt;p&gt;Connected to server. Enter your username.&lt;/p&gt;&quot;);
      };

      socket.onmessage = function (message) {
        log.append(&quot;&lt;p&gt;&quot; + message.data + &quot;&lt;/p&gt;&quot;);
      };

      socket.onclose = function () {
        log.append(&quot;&lt;p&gt;Connection to server was lost.&lt;/p&gt;&quot;);
      };

      sendMessageButton.on(&#39;click&#39;, function () {
        var text = message.val();
        if ($.trim(text) !== &#39;&#39;) {
          // Send the message and clear the text.
          socket.send(text);

          message.val(&quot;&quot;);
          message.focus();
          return;
        }
        message.focus();
      });
    });
  &lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
&lt;div id=&quot;chatroom&quot;&gt;
  &lt;input type=&quot;text&quot; id=&quot;message&quot; placeholder=&quot;Enter your username first, then chat&quot;&gt;&lt;br&gt;

  &lt;div id=&quot;log&quot;&gt;&lt;/div&gt;&lt;br&gt;
  &lt;button id=&quot;send-message-button&quot;&gt;Send&lt;/button&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>You can then run the application using <code>grails run-app</code> to see it in action.</p>

<h2>Conclusion</h2>

<p>This is a simple example, which does not handle things such as XSS prevention or HTML encoding, but it should be sufficient to get started. Feel free to post a comment if you have any questions or run into any problems.</p>

              </div>
              <br>
                <div class="comments">
                  <div id="disqus_thread"></div>
                  <script type="text/javascript">
                    var disqus_shortname = 'caseyscarboroughcom'; 
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                  </script>
                  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
  <div class="row">
    <div class="col-md-3 hidden-sm"></div>
    <div class="col-md-6">
      <div class="footer">
        <p class="pull-left icons">
          <a target="_blank" class="tooltip-link" title="Email" href="mailto:caseyscarborough@gmail.com"><i class="fa fa-envelope"></i></a>&nbsp;&nbsp;
          <a target="_blank" class="tooltip-link" title="GitHub" href="https://github.com/caseyscarborough/"><i class="fa fa-github"></i></a>&nbsp;&nbsp;
          <a target="_blank" class="tooltip-link" title="BitBucket" href="https://bitbucket.org/caseyscarborough/"><i class="fa fa-bitbucket"></i></a>&nbsp;&nbsp;
          <a target="_blank" class="tooltip-link" title="LinkedIn" href="https://linkedin.com/in/caseyscarborough"><i class="fa fa-linkedin"></i></a>&nbsp;&nbsp;
          <a target="_blank" class="tooltip-link" title="Google+" href="https://plus.google.com/103526747321763836028?rel=author"><i class="fa fa-google-plus"></i></a>
        </p>
        <p class="pull-right">
          <small class="meta">Contribute to this site on <a target="_blank" href="https://github.com/caseyscarborough/caseyscarborough.github.io">GitHub</a>.</small><br>
        </p>
      </div>
    </div>
  </div>
</div>
    </body>
</html>
